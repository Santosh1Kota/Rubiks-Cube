<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AnimCube Playground - External Controls</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0b1020; color:#e5e7eb; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950">
  <div id="fsWrap">
  <div class="max-w-6xl mx-auto px-4 pt-6 pb-32">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-semibold text-white">AnimCube Interactive</h1>
      <p class="text-slate-300 mt-1">Learn patterns step-by-step with a smooth, modern interface.</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Cube Card -->
      <section class="lg:col-span-2">
        <div class="relative rounded-2xl border border-slate-700/60 bg-white/5 backdrop-blur-md shadow-2xl p-4">
          <div id="acWrap" class="relative w-[min(90vw,75vh,800px)] aspect-square mx-auto select-none">
            <div id="acpg" class="absolute inset-0 opacity-0 transition-opacity duration-500"></div>
            <div id="badge" class="hidden absolute top-2 right-2 bg-black/60 border border-blue-700/60 text-blue-100 rounded-md px-3 py-1 text-sm font-medium">Move <span id="badgeTextNum">0</span> of <span id="badgeTextTotal">0</span></div>
            <!-- Overlay fullscreen toggle (industry standard) -->
            <button id="fsToggleOverlay" title="Toggle fullscreen (F)" aria-label="Toggle fullscreen"
              class="absolute top-2 left-2 bg-black/50 hover:bg-black/60 active:scale-95 transition text-slate-100 border border-slate-700 rounded-full p-2">
              <!-- Enter fullscreen (from provided SVG) -->
              <svg id="fsEnterIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M7.69233 18.2781L9.70711 20.2929C9.9931 20.5789 10.0787 21.009 9.92388 21.3827C9.7691 21.7564 9.40446 22 9 22H3C2.44772 22 2 21.5523 2 21V15C2 14.5955 2.24364 14.2309 2.61732 14.0761C2.99099 13.9213 3.42111 14.0069 3.70711 14.2929L5.571 16.1568L9.25289 12.4749C9.64342 12.0844 10.2766 12.0844 10.6671 12.4749L11.3742 13.182C11.7647 13.5725 11.7647 14.2057 11.3742 14.5962L7.69233 18.2781Z" />
                <path d="M16.3077 5.72187L14.2929 3.70711C14.0069 3.42111 13.9213 2.99099 14.0761 2.61732C14.2309 2.24364 14.5955 2 15 2H21C21.5523 2 22 2.44772 22 3V9C22 9.40446 21.7564 9.7691 21.3827 9.92388C21.009 10.0787 20.5789 9.9931 20.2929 9.70711L18.429 7.84319L14.7471 11.5251C14.3566 11.9156 13.7234 11.9156 13.3329 11.5251L12.6258 10.818C12.2352 10.4275 12.2352 9.7943 12.6258 9.40378L16.3077 5.72187Z" />
              </svg>
              <!-- Exit fullscreen (from provided SVG) -->
              <svg id="fsExitIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M20.04 10.1109L18.0252 8.09612L21.7071 4.41421C22.0976 4.02369 22.0976 3.39052 21.7071 3L21 2.29289C20.6095 1.90237 19.9763 1.90237 19.5858 2.29289L15.9039 5.9748L14.04 4.11089C13.754 3.82489 13.3239 3.73933 12.9502 3.89411C12.5765 4.04889 12.3329 4.41353 12.3329 4.81799V10.818C12.3329 11.3703 12.7806 11.818 13.3329 11.818H19.3329C19.7373 11.818 20.102 11.5744 20.2568 11.2007C20.4115 10.827 20.326 10.3969 20.04 10.1109Z" />
                <path d="M3.96 13.8891L5.97478 15.9039L2.29289 19.5858C1.90237 19.9763 1.90237 20.6095 2.29289 21L3 21.7071C3.39052 22.0976 4.02369 22.0976 4.41421 21.7071L8.0961 18.0252L9.96 19.8891C10.246 20.1751 10.6761 20.2607 11.0498 20.1059C11.4235 19.9511 11.6671 19.5865 11.6671 19.182V13.182C11.6671 12.6297 11.2194 12.182 10.6671 12.182H4.66711C4.26265 12.182 3.89801 12.4256 3.74323 12.7993C3.58845 13.173 3.674 13.6031 3.96 13.8891Z" />
              </svg>
            </button>
          </div>
        </div>
      </section>

      <!-- History / Info Panel -->
      <aside class="rounded-2xl border border-slate-700/60 bg-white/5 backdrop-blur-md shadow-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-slate-100 font-medium">Move History</h2>
          <span id="countChip" class="text-xs text-blue-200 bg-blue-900/30 border border-blue-800/40 rounded-md px-2 py-0.5">0 / 0</span>
        </div>
        <div id="historyList" class="flex flex-wrap gap-2"></div>
        <div class="mt-4 text-xs text-slate-400">Tip: Click a move to jump to that point.</div>
      </aside>
    </main>
  </div>

  <!-- Bottom Toolbar -->
  <div class="fixed bottom-0 inset-x-0 z-50">
    <div class="mx-auto max-w-6xl px-4 pb-4">
      <div class="rounded-2xl border border-slate-700/60 bg-white/10 backdrop-blur-md shadow-2xl p-3">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <button id="btnPlay" class="bg-blue-600 hover:bg-blue-700 active:scale-95 transition text-white rounded-md px-4 py-2 shadow disabled:opacity-50" disabled>Play</button>
            <button id="btnPause" class="bg-slate-800 hover:bg-slate-700 active:scale-95 transition text-slate-100 rounded-md px-4 py-2 border border-slate-700 disabled:opacity-50" disabled>Pause</button>
            <button id="btnPrev" class="bg-slate-800 hover:bg-slate-700 active:scale-95 transition text-slate-100 rounded-md px-4 py-2 border border-slate-700 disabled:opacity-50" disabled>Prev</button>
            <button id="btnNext" class="bg-slate-800 hover:bg-slate-700 active:scale-95 transition text-slate-100 rounded-md px-4 py-2 border border-slate-700 disabled:opacity-50" disabled>Next</button>
            <button id="btnReset" class="bg-slate-800 hover:bg-slate-700 active:scale-95 transition text-slate-100 rounded-md px-4 py-2 border border-slate-700 disabled:opacity-50" disabled>Reset</button>
            <button id="btnSnap" class="bg-slate-800 hover:bg-slate-700 active:scale-95 transition text-slate-100 rounded-md px-4 py-2 border border-slate-700 disabled:opacity-50" disabled>Snap</button>
            <!-- Removed explicit fullscreen button; use overlay, dblâ€‘click, or "F" key -->
          </div>
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
              <span class="text-slate-300 text-sm">Delay</span>
              <input type="range" id="delay" min="0" max="3000" step="100" value="800" class="accent-blue-500" />
              <span id="delayVal" class="text-blue-200 text-sm">800 ms</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-slate-300 text-sm">Speed</span>
              <input type="range" id="speed" min="1" max="20" value="10" class="accent-blue-500" />
              <span id="speedVal" class="text-blue-200 text-sm">10</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- AnimCube3 script (CDN) -->
  <script src="https://cdn.jsdelivr.net/gh/cubing/AnimCubeJS/AnimCube3.js"></script>
  <script>
    const AC_ID = 'acpg';
    const DEFAULT_MOVES = "R U R' U'";
    const $ = (id) => document.getElementById(id);

    // AnimCubeJS globals
    var acjs_cube = [], acjs_move = [], acjs_getMove = [], acjs_doMove = [], acjs_startAnimation = [], acjs_pauseAnimation = [], acjs_stopAnimation = [], acjs_clear = [], acjs_get_var = [], acjs_put_var = [], acjs_paint = [], acjs_eye = [], acjs_eyeX = [], acjs_eyeY = [], acjs_initialEye = [], acjs_initialEyeX = [], acjs_initialEyeY = [], acjs_vCopy = [];

    function isReadyLib() { return !!window.AnimCube3 }
    function isReadyInstance() { return !!(window.acjs_get_var?.[AC_ID] || window.acjs_move?.[AC_ID] || window.acjs_startAnimation?.[AC_ID]) }
    function setControlsEnabled(enabled) {
      ['btnPlay','btnPause','btnPrev','btnNext','btnReset','btnSnap','btnRead'].forEach(id => { const el = $(id); if (el) el.disabled = !enabled })
    }

    // Stacks
    let originalTokens = [], doneMoves = [], todoMoves = []
    let playPollTimer = null, tokenPollTimer = null, queuePlaying = false

    function updateUI() {
      const total = originalTokens.length || 0
      const completed = doneMoves.length || 0
      $('badgeTextNum').textContent = String(completed)
      $('badgeTextTotal').textContent = String(total)
      $('badge').classList.toggle('hidden', total === 0)
      renderHistory(completed)
      $('countChip').textContent = `${completed} / ${total}`
    }

    function renderHistory(currentIdx) {
      const list = $('historyList'); if (!list) return
      list.innerHTML = ''
      originalTokens.forEach((mv, i) => {
        const btn = document.createElement('button')
        btn.textContent = mv
        btn.className = `px-3 py-1 rounded-full text-xs border transition ${i < currentIdx ? 'bg-blue-600/30 text-blue-100 border-blue-500/40' : i === currentIdx ? 'bg-blue-600/50 text-blue-50 border-blue-400/50' : 'bg-slate-900/60 text-slate-200 border-slate-700'}`
        btn.onclick = () => jumpToIndex(i)
        list.appendChild(btn)
      })
    }

    function jumpToIndex(idx) {
      try { if (acjs_get_var?.[AC_ID]('animating')) acjs_stopAnimation?.[AC_ID]?.() } catch {}
      try {
        acjs_clear[AC_ID]()
        doneMoves = []
        for (let i = 0; i < idx; i++) {
          const seq = acjs_getMove[AC_ID](originalTokens[i], 0)
          acjs_doMove[AC_ID](acjs_cube[AC_ID], seq[0], 0, seq[0].length, false)
          doneMoves.push(originalTokens[i])
        }
        todoMoves = originalTokens.slice(idx)
        acjs_paint[AC_ID]()
        updateUI()
      } catch (e) {}
    }

    function snapView() {
      try {
        const vCopy = acjs_vCopy[AC_ID]
        vCopy(acjs_eye[AC_ID], acjs_initialEye[AC_ID])
        vCopy(acjs_eyeX[AC_ID], acjs_initialEyeX[AC_ID])
        vCopy(acjs_eyeY[AC_ID], acjs_initialEyeY[AC_ID])
        acjs_paint[AC_ID]()
      } catch {}
    }

    function waitForInstanceReady(maxMs = 10000) {
      return new Promise((resolve) => {
        const start = Date.now()
        const tick = () => { if (isReadyInstance()) return resolve(true); if (Date.now() - start > maxMs) return resolve(false); setTimeout(tick, 50) }
        tick()
      })
    }

    async function initCube() {
      if (!isReadyLib()) return
      setControlsEnabled(false)
      // Include facelets captured from camera if present
      const facelets = (typeof window !== 'undefined' && sessionStorage.getItem('animcube_facelets')) || ''
      const params = `id=${AC_ID}&listen=1&buttonbar=0&counter=1&bgcolor=101020&cubecolor=000000&borderwidth=8&perspective=2&snap=1${facelets ? `&facelets=${encodeURIComponent(facelets)}` : ''}&scale=1`
      try { if (window.acjs_removeListeners?.[AC_ID]) window.acjs_removeListeners[AC_ID]() } catch {}
      window.AnimCube3(params)
      const ok = await waitForInstanceReady(10000)
      if (!ok) return
      setControlsEnabled(true)
      $('acpg').classList.remove('opacity-0')
      // Default to camera moves if available from backend; else fallback to DEFAULT_MOVES
      try {
        const r = await fetch('http://localhost:8001/moves')
        const d = await r.json()
        const arr = (d?.moves_animcube || d?.moves_made || d?.moves)
        if (Array.isArray(arr) && arr.length > 0) {
          originalTokens = arr
        } else {
          originalTokens = DEFAULT_MOVES.split(/\s+/).filter(Boolean)
        }
      } catch {
        originalTokens = DEFAULT_MOVES.split(/\s+/).filter(Boolean)
      }
      doneMoves = []
      todoMoves = originalTokens.slice()
      updateUI()
      // Wire speed initial
      const sp = $('speed'); if (sp) { const v = parseInt(sp.value, 10) || 10; $('speedVal').textContent = String(v); try { acjs_put_var?.[AC_ID]?.('speed', v) } catch {} }
      // Enable buttons now that cube is ready
      ;['btnPlay','btnPause','btnPrev','btnNext','btnReset','btnSnap'].forEach(id => { const el = $(id); if (el) el.removeAttribute('disabled') })
    }

    async function play() {
      if (!isReadyInstance()) return
      try { if (acjs_get_var?.[AC_ID]('animating')) acjs_stopAnimation?.[AC_ID]?.() } catch {}
      if (!todoMoves || todoMoves.length === 0) return
      queuePlaying = true
      const playNext = () => {
        if (!queuePlaying) return
        if (todoMoves.length === 0) { queuePlaying = false; return }
        try {
          const mv = todoMoves.shift()
          if (!acjs_move[AC_ID]) acjs_move[AC_ID] = []
          const seq = acjs_getMove[AC_ID](mv, 0)
          acjs_move[AC_ID][0] = seq[0]
          acjs_startAnimation[AC_ID](0)
          if (tokenPollTimer) clearInterval(tokenPollTimer)
          tokenPollTimer = setInterval(() => {
            try {
              const anim = acjs_get_var?.[AC_ID]('animating')
              if (!anim) {
                clearInterval(tokenPollTimer); tokenPollTimer = null
                doneMoves.push(mv)
                updateUI()
                const ms = parseInt(($('delay')?.value || '0'), 10) || 0
                setTimeout(playNext, ms)
              }
            } catch {}
          }, 60)
        } catch { queuePlaying = false }
      }
      playNext()
    }

    async function pause() { if (!isReadyInstance()) return; if (acjs_pauseAnimation?.[AC_ID]) acjs_pauseAnimation[AC_ID](); else acjs_stopAnimation?.[AC_ID]?.() }

    async function step(delta) {
      if (!isReadyInstance()) return
      try { if (acjs_get_var?.[AC_ID]('animating')) acjs_stopAnimation?.[AC_ID]?.() } catch {}
      if (delta > 0) {
        if (todoMoves.length === 0) return
        const mv = todoMoves.shift()
        try {
          if (!acjs_move[AC_ID]) acjs_move[AC_ID] = []
          const seq = acjs_getMove[AC_ID](mv, 0)
          acjs_move[AC_ID][0] = seq[0]
          acjs_startAnimation[AC_ID](0)
          doneMoves.push(mv)
          updateUI()
        } catch {}
      } else if (delta < 0) {
        if (doneMoves.length === 0) return
        const prev = doneMoves.pop()
        const inv = prev.endsWith('2') ? prev : (prev.endsWith("'") ? prev.slice(0,-1) : prev + "'")
        try {
          if (!acjs_move[AC_ID]) acjs_move[AC_ID] = []
          const seq = acjs_getMove[AC_ID](inv, 0)
          acjs_move[AC_ID][0] = seq[0]
          acjs_startAnimation[AC_ID](0)
          todoMoves.unshift(prev)
          updateUI()
        } catch {}
      }
    }

    async function resetCube() {
      if (!isReadyInstance()) return
      try {
        if (acjs_get_var?.[AC_ID] && acjs_get_var[AC_ID]('animating')) { acjs_stopAnimation?.[AC_ID]?.(); setTimeout(resetCube, 10) }
        else { acjs_clear?.[AC_ID]?.(); doneMoves = []; todoMoves = originalTokens.slice(); updateUI() }
      } catch {}
    }

    function cleanListeners() { try { window.acjs_removeListeners?.[AC_ID]?.() } catch {} }

    // Industry-standard FS toggles
    function toggleFullscreen() {
      const ac = $('acWrap')
      if (!document.fullscreenElement) { ac?.requestFullscreen?.() } else { document.exitFullscreen?.() }
    }

    // Bind events
    $('btnPlay').onclick = play
    $('btnPause').onclick = pause
    $('btnNext').onclick = () => step(1)
    $('btnPrev').onclick = () => step(-1)
    $('btnReset').onclick = resetCube
    $('btnSnap').onclick = snapView
    $('fsToggleOverlay').onclick = toggleFullscreen
    $('acWrap').ondblclick = toggleFullscreen
    document.addEventListener('keydown', (e) => { if (e.key === 'f' || e.key === 'F') toggleFullscreen() })
    $('delay').addEventListener('input', (e) => { $('delayVal').textContent = `${parseInt(e.target.value,10)||0} ms` })
    $('speed').addEventListener('input', (e) => { const v = parseInt(e.target.value,10)||10; $('speedVal').textContent = String(v); try { acjs_put_var?.[AC_ID]?.('speed', v) } catch {} })

    // Keep toolbar visible in cube fullscreen: move it inside acWrap during fullscreen
    const tbFixed = document.querySelector('.fixed.bottom-0.inset-x-0.z-50')
    let tbPlaceholder = null
    document.addEventListener('fullscreenchange', () => {
      const ac = $('acWrap')
      const isFs = document.fullscreenElement === ac
      const enterI = $('fsEnterIcon'), exitI = $('fsExitIcon')
      if (enterI && exitI) {
        if (isFs) { enterI.classList.add('hidden'); exitI.classList.remove('hidden') }
        else { exitI.classList.add('hidden'); enterI.classList.remove('hidden') }
      }
      if (isFs && tbFixed) {
        if (!tbPlaceholder) { tbPlaceholder = document.createElement('div'); tbPlaceholder.id = 'tbPH'; tbFixed.parentNode.insertBefore(tbPlaceholder, tbFixed) }
        tbFixed.classList.remove('fixed','inset-x-0','bottom-0')
        tbFixed.classList.add('absolute','left-0','right-0','bottom-0')
        ac.appendChild(tbFixed)
        try { acjs_put_var?.[AC_ID]?.('scale', 0.92) } catch {}
      } else if (!isFs && tbPlaceholder && tbFixed) {
        tbFixed.classList.remove('absolute','left-0','right-0','bottom-0')
        tbFixed.classList.add('fixed','inset-x-0','bottom-0')
        tbPlaceholder.parentNode.insertBefore(tbFixed, tbPlaceholder)
        tbPlaceholder.remove(); tbPlaceholder = null
        try { acjs_put_var?.[AC_ID]?.('scale', 1) } catch {}
      }
    })

    // Auto-init
    window.addEventListener('load', async () => {
      const waitLib = () => new Promise(r => { const t = setInterval(() => { if (isReadyLib()) { clearInterval(t); r(true) } }, 50) })
      await waitLib()
      setTimeout(initCube, 100)
    })
  </script>
</body>
</html>